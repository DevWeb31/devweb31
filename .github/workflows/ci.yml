name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'
  NPM_VERSION: 'latest'

jobs:
  # VÃ©rification de la qualitÃ© du code
  quality:
    name: ğŸ” QualitÃ© du Code
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸ§¹ Linting avec ESLint
        run: npm run lint
        
      - name: ğŸ” VÃ©rification TypeScript
        run: npm run type-check
        
      - name: ğŸ“ VÃ©rification du formatage
        run: npm run format:check

  # Tests automatisÃ©s
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸ§ª ExÃ©cution des tests
        run: npm test
        
      - name: ğŸ“Š Couverture de code
        run: npm run test:coverage

  # Build et vÃ©rification
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [quality, test]
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸ” Configuration des variables d'environnement
        run: |
          echo "VITE_SUPABASE_URL=https://example.supabase.co" >> .env
          echo "VITE_SUPABASE_ANON_KEY=example-key" >> .env
          
      - name: ğŸ—ï¸ Build de production
        run: npm run build
        
      - name: ğŸ“ VÃ©rification de la taille du bundle
        run: |
          echo "Build terminÃ© avec succÃ¨s"
          ls -la dist/

  # Tests de sÃ©curitÃ©
  security:
    name: ğŸ›¡ï¸ SÃ©curitÃ©
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸ” Audit de sÃ©curitÃ© npm
        run: npm audit --audit-level=moderate || echo "Audit terminÃ© avec des avertissements"

  # Tests de performance
  performance:
    name: âš¡ Performance
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸ—ï¸ Build de production
        run: npm run build
        
      - name: ğŸ“Š Analyse de la taille du bundle
        run: |
          echo "Analyse de la taille du bundle :"
          du -sh dist/
          echo "Fichiers dans dist/:"
          find dist/ -type f -exec ls -lh {} \;

  # DÃ©ploiement automatique
  deploy:
    name: ğŸš€ DÃ©ploiement
    runs-on: ubuntu-latest
    needs: [build, security, performance]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸ—ï¸ Build de production
        run: npm run build
        
      - name: ğŸš€ DÃ©ploiement sur Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
        
      - name: ğŸ“ DÃ©ploiement simulÃ©
        run: |
          echo "DÃ©ploiement simulÃ© - VERCEL_TOKEN non configurÃ©"
          echo "Build prÃªt pour dÃ©ploiement manuel"

  # Notification de succÃ¨s
  notify-success:
    name: âœ… Notification de SuccÃ¨s
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && success()
    
    steps:
      - name: ğŸ“ Log de succÃ¨s
        run: |
          echo "âœ… Build rÃ©ussi pour DevWeb31 !"
          echo "Commit: ${{ github.sha }}"
          echo "Branche: ${{ github.ref }}"
          echo "Auteur: ${{ github.actor }}"

  # Notification d'Ã©chec
  notify-failure:
    name: âŒ Notification d'Ã‰chec
    runs-on: ubuntu-latest
    needs: [quality, test, build, security, performance]
    if: failure()
    
    steps:
      - name: ğŸ“ Log d'Ã©chec
        run: |
          echo "âŒ Build Ã©chouÃ© pour DevWeb31 !"
          echo "Commit: ${{ github.sha }}"
          echo "Branche: ${{ github.ref }}"
          echo "Auteur: ${{ github.actor }}"
          echo "Veuillez vÃ©rifier et corriger les erreurs"
