name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # VÃ©rification de la qualitÃ© du code
  quality:
    name: ğŸ” QualitÃ© du Code
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸ§¹ Linting avec ESLint
        run: npm run lint
        
      - name: ğŸ” VÃ©rification TypeScript
        run: npx tsc --noEmit
        
      - name: ğŸ“ VÃ©rification du formatage
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}"

  # Tests automatisÃ©s
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸ§ª ExÃ©cution des tests
        run: npm test
        
      - name: ğŸ“Š Couverture de code
        run: npm run test:coverage
        
      - name: ğŸ“ˆ Upload de la couverture
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # Build et vÃ©rification
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [quality, test]
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸ” Configuration des variables d'environnement
        run: |
          echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}" >> .env
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}" >> .env
          
      - name: ğŸ—ï¸ Build de production
        run: npm run build
        
      - name: ğŸ“ VÃ©rification de la taille du bundle
        run: |
          npm install -g bundle-analyzer
          bundle-analyzer dist/stats.html
          
      - name: ğŸ§ª Test de la build
        run: npm run preview &
          sleep 10
          npm run test:e2e

  # Tests de sÃ©curitÃ©
  security:
    name: ğŸ›¡ï¸ SÃ©curitÃ©
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸ” Audit de sÃ©curitÃ© npm
        run: npm audit --audit-level=moderate
        
      - name: ğŸ› Scan des vulnÃ©rabilitÃ©s
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # Tests de performance
  performance:
    name: âš¡ Performance
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸš€ Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:4173/
          uploadArtifacts: true
          temporaryPublicStorage: true

  # DÃ©ploiement automatique
  deploy:
    name: ğŸš€ DÃ©ploiement
    runs-on: ubuntu-latest
    needs: [build, security, performance]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci
        
      - name: ğŸ—ï¸ Build de production
        run: npm run build
        
      - name: ğŸš€ DÃ©ploiement sur Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

  # Notification de succÃ¨s
  notify-success:
    name: âœ… Notification de SuccÃ¨s
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: ğŸ“§ Envoi d'email de succÃ¨s
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… Build DevWeb31 rÃ©ussi"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: "CI/CD DevWeb31"
          body: |
            ğŸ‰ Build rÃ©ussi pour DevWeb31 !
            
            ğŸ“Š RÃ©sumÃ© :
            - Commit: ${{ github.sha }}
            - Branche: ${{ github.ref }}
            - Auteur: ${{ github.actor }}
            - Date: ${{ github.event.head_commit.timestamp }}
            
            ğŸ”— Voir les dÃ©tails : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  # Notification d'Ã©chec
  notify-failure:
    name: âŒ Notification d'Ã‰chec
    runs-on: ubuntu-latest
    needs: [quality, test, build, security, performance]
    if: failure()
    
    steps:
      - name: ğŸ“§ Envoi d'email d'Ã©chec
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ Build DevWeb31 Ã©chouÃ©"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: "CI/CD DevWeb31"
          body: |
            ğŸš¨ Build Ã©chouÃ© pour DevWeb31 !
            
            ğŸ“Š RÃ©sumÃ© :
            - Commit: ${{ github.sha }}
            - Branche: ${{ github.ref }}
            - Auteur: ${{ github.actor }}
            - Date: ${{ github.event.head_commit.timestamp }}
            
            ğŸ”— Voir les dÃ©tails : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            âš ï¸ Veuillez vÃ©rifier et corriger les erreurs.
